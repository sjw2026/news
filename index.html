<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b57d0" />
  <title>섹션별 TOP 10 뉴스</title>

  <style>
    :root{
      --text:#eaf0ff; --muted:rgba(234,240,255,.7);
      --line:rgba(255,255,255,.08); --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:18px; --good:#2ecc71; --up:#4aa3ff; --down:#f1c40f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;background:linear-gradient(180deg,#081022,#060b16);color:var(--text)}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(6,11,22,.82);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:14px}
    h1{margin:0;font-size:16px;font-weight:800}
    .badge{display:inline-flex;align-items:center;gap:6px;margin-top:6px;padding:6px 10px;border-radius:999px;background:rgba(11,87,208,.2);border:1px solid rgba(11,87,208,.4);font-size:12px;font-weight:700}
    .dot{width:7px;height:7px;border-radius:50%;background:#4aa3ff;box-shadow:0 0 0 4px rgba(74,163,255,.25)}
    .wrap{max-width:860px;margin:0 auto;padding:12px 12px 80px}
    .controls{margin-top:12px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .controls select,.controls input{width:100%;padding:12px;margin-top:8px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(16,31,56,.7);color:var(--text);font-size:14px;outline:none}
    details.sec{margin-top:14px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    summary{list-style:none;cursor:pointer;padding:14px;display:flex;justify-content:space-between;align-items:center}
    summary::-webkit-details-marker{display:none}
    .secName{font-size:15px;font-weight:900}
    .count{font-size:12px;color:var(--muted)}
    a.item{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line)}
    .rank{width:34px;height:34px;border-radius:12px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-weight:900;flex:0 0 auto}
    .title{font-size:14px;font-weight:700;line-height:1.35}
    .meta{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
    .trend{font-weight:900}
    .new{color:var(--good)} .up{color:var(--up)} .down{color:var(--down)}
    .error{margin-top:14px;padding:12px 14px;border-radius:var(--radius);border:1px solid rgba(231,76,60,.35);background:rgba(231,76,60,.10);color:#ffd6d2;white-space:pre-wrap}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
<header>
  <h1>섹션별 TOP 10 뉴스</h1>
  <div class="badge" id="updateBadge"><span class="dot"></span>업데이트: 로딩 중</div>
</header>

<div class="wrap">
  <div class="controls">
    <select id="sectionFilter"><option value="">전체 섹션</option></select>
    <input id="q" placeholder="검색 (제목/언론사)" />
  </div>
  <div id="app"></div>
</div>

<script>
/* ================= 설정 ================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSN0ws79-rlmWgsTFRzGqsqN1FFDt_jz__Ot8pVLF58vD8gB99hrgJCFx-_dcSqAJ9oFjKRw-icxTBw/pub?single=true&output=csv&gid=669685207";
const SECTION_ORDER = ["경제","국제","IT","정치","사회"];
const LS_KEY = "newsranker_prev_v1";

/* ================= 유틸 ================= */
const esc = s => String(s||"")
  .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

function showError(msg, detail){
  const app = document.getElementById("app");
  app.innerHTML = `<div class="error"><b>오류</b>\n${esc(msg)}${detail?`\n\n${esc(detail)}`:""}</div>`;
}

function parseCSV(t){
  const r=[]; let c="",row=[],q=false;
  for(let i=0;i<t.length;i++){
    const x=t[i],n=t[i+1];
    if(x==='"'){ if(q&&n==='"'){c+='"';i++;} else q=!q; continue; }
    if(!q&&(x===','||x==='\n'||x==='\r')){
      if(x==='\r'&&n==='\n') continue;
      row.push(c); c="";
      if (x !== ',') { // ✅ FIX: 문법 오류(!===) → !==
        r.push(row);
        row=[];
      }
      continue;
    }
    c+=x;
  }
  if(c || row.length){ row.push(c); r.push(row); }
  return r;
}

function sectionSort(a,b){
  const ia=SECTION_ORDER.indexOf(a);
  const ib=SECTION_ORDER.indexOf(b);
  if(ia>-1||ib>-1) return (ia>-1?ia:99)-(ib>-1?ib:99);
  return a.localeCompare(b,"ko");
}

function loadPrev(){
  try{
    return new Map(JSON.parse(localStorage.getItem(LS_KEY)||"[]").map(x=>[x.section+"||"+x.link,x]));
  }catch{ return new Map(); }
}
function savePrev(data){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(data.map(d=>({section:d.section,link:d.link,rank:d.rank}))));
  }catch{}
}

/* ================= 메인 ================= */
(async function(){
  try{
    const res = await fetch(CSV_URL,{cache:"no-store"});
    if(!res.ok){
      showError("CSV를 불러오지 못했습니다. HTTP "+res.status, "URL: "+CSV_URL);
      return;
    }
    const text = await res.text();

    // CSV가 아니라 HTML이 오면 여기서 걸리게끔(간단 감지)
    if (text.trim().startsWith("<!doctype") || text.trim().startsWith("<html")) {
      showError("CSV 대신 HTML이 내려옵니다. (웹에 게시 CSV 링크가 맞는지/권한이 공개인지 확인)", text.slice(0,200));
      return;
    }

    const rows = parseCSV(text);
    if(!rows.length || rows.length < 2){
      showError("CSV 파싱 결과가 비어 있습니다.", text.slice(0,200));
      return;
    }

    const h = rows[0].map(x => (x||"").trim());
    const idx = n => h.indexOf(n);

    const must = ["runAt","section","rank","totalScore","publisher","title","link"];
    const missing = must.filter(k => !h.includes(k));
    if(missing.length){
      showError("CSV 헤더가 예상과 다릅니다. TOP_SECTION 1행 헤더(runAt/section/...) 확인 필요",
        "missing: "+missing.join(", ")+"\nheader: "+h.join(" | "));
      return;
    }

    const data = rows.slice(1).map(r=>({
      runAt:r[idx("runAt")],
      section:(r[idx("section")]||"").trim(),
      rank:+(r[idx("rank")]||""),
      total:+(r[idx("totalScore")]||""),
      publisher:(r[idx("publisher")]||"").trim(),
      title:(r[idx("title")]||"").trim(),
      link:(r[idx("link")]||"").trim()
    })).filter(x=>x.section && x.title && x.link);

    if(!data.length){
      showError("데이터가 0건입니다. TOP_SECTION 시트에 값이 채워져 있는지 확인하세요.", text.slice(0,200));
      return;
    }

    // 업데이트 배지(데이터 없을 때 죽지 않게)
    document.getElementById("updateBadge").innerHTML =
      `<span class="dot"></span>업데이트: ${esc(data[0]?.runAt || "알 수 없음")}`;

    // 섹션 목록
    const sections = [...new Set(data.map(d=>d.section))].sort(sectionSort);
    const sel = document.getElementById("sectionFilter");
    sel.innerHTML = `<option value="">전체 섹션</option>`;
    sections.forEach(s=>{
      const o=document.createElement("option");
      o.value=s; o.textContent=s;
      sel.appendChild(o);
    });

    const prev = loadPrev();
    const app = document.getElementById("app");

    function render(){
      const q = (document.getElementById("q").value||"").toLowerCase().trim();
      const sf = sel.value;
      app.innerHTML = "";

      sections.forEach(sec=>{
        if(sf && sf!==sec) return;

        let arr = data.filter(d=>d.section===sec);
        if(q){
          arr = arr.filter(d =>
            (d.title||"").toLowerCase().includes(q) ||
            (d.publisher||"").toLowerCase().includes(q)
          );
        }
        if(!arr.length) return;

        arr.sort((a,b)=>a.rank-b.rank);

        const det = document.createElement("details");
        det.className="sec";
        det.innerHTML = `<summary>
          <div class="secName">${esc(sec)}</div>
          <div class="count">${arr.length}건</div>
        </summary>`;

        arr.forEach(it=>{
          const k = it.section+"||"+it.link;
          let t="—", cls="";
          if(!prev.has(k)){ t="NEW"; cls="new"; }
          else{
            const pr = prev.get(k).rank;
            if(it.rank < pr){ t="↑"+(pr-it.rank); cls="up"; }
            else if(it.rank > pr){ t="↓"+(it.rank-pr); cls="down"; }
          }

          const a = document.createElement("a");
          a.className="item";
          a.href=it.link;
          a.target="_blank";
          a.rel="noreferrer noopener";
          a.innerHTML = `
            <div class="rank">${Number.isFinite(it.rank)?it.rank:""}</div>
            <div style="min-width:0">
              <div class="title">${esc(it.title)}</div>
              <div class="meta">
                <span class="trend ${cls}">${esc(t)}</span>
                <span class="pill">${esc(it.publisher)}</span>
                <span class="pill">점수 ${Number.isFinite(it.total)?it.total:""}</span>
              </div>
            </div>`;
          det.appendChild(a);
        });

        app.appendChild(det);
      });

      savePrev(data);
    }

    sel.onchange = render;
    document.getElementById("q").oninput = render;
    render();

  }catch(e){
    showError("스크립트 실행 중 예외가 발생했습니다.", String(e));
  }
})();
</script>
</body>
</html>
